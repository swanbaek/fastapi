{% extends 'base.html' %}
{% block title %}마이페이지{% endblock %}

{% block content %}
<div class="container">
    <h2>마이페이지</h2>

    <div id="userInfoBox">
        <p><strong>번호:</strong> <span id="myId"></span></p>
        <p><strong>이름:</strong> <span id="myName"></span></p>
        <p><strong>이메일:</strong> <span id="myEmail"></span></p>
        <p><strong>가입일:</strong> <span id="myCreated"></span></p>
        <p><strong>ROLE:</strong> <span id="myRole"></span></p>
    </div>

    <form id="updateForm">
        <div>
            <label>이름</label>
            <input type="text" id="name">
        </div>
        <div>
            <label>이메일</label>
            <input type="email" id="email">
        </div>
        <div>
            <label>비밀번호 변경 (선택)</label>
            <input type="password" id="password">
        </div>
        <button type="submit">정보수정</button>
    </form>

    <div id="deletePw" style="margin-top:20px;">
        <label>비밀번호 확인</label>
        <input type="password" id="deletePassword" required>
    </div>

    <button id="deleteBtn" style="background:#e53935;margin-top:20px;">
        회원탈퇴
    </button>

    <div class="result" id="mypageResult"></div>
</div>
{% endblock %}

{% block script %}
<script src="/static/common.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    // 1. 회원정보 로드
    const res = await apiFetch("/users/me");
    
    if (res.ok) {
        
        const user = await res.json();
        // alert(JSON.stringify(user));
        document.getElementById("myId").textContent = user.id;
        document.getElementById("myName").textContent = user.name;
        document.getElementById("myEmail").textContent = user.email;
        document.getElementById("myCreated").textContent = user.created_at.replace("T"," ").slice(0,19);
        document.getElementById("name").value = user.name;
        document.getElementById("email").value = user.email;
        document.getElementById("myRole").textContent = user.role || "N/A";
    } else {
        document.getElementById("userInfoBox").innerHTML = '<div style="color:red;">로그인 후 이용 가능합니다.</div>';
        document.getElementById("updateForm").style.display = "none";
        document.getElementById("deletePw").style.display = "none";
        document.getElementById("deleteBtn").style.display = "none";
        return;
    }
    // 2. 회원정보 수정
    document.getElementById("updateForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const body = {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value
        };
        const pw = document.getElementById("password").value;
        if (pw) body.password = pw;
        const update = await apiFetch("/users/me", {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });

        const result = document.getElementById("mypageResult");
        if (update.ok) {
            result.textContent = "정보가 수정되었습니다.";
            setTimeout(() => location.reload(), 800);
        } else {
            const err = await update.json();
            result.textContent = "오류: " + err.detail;
        }
    });

    // 3. 회원탈퇴
    document.getElementById("deleteBtn").addEventListener("click", async () => {
        if (!confirm("정말 회원탈퇴 하시겠습니까?")) return;

        const password = document.getElementById("deletePassword").value;
        if (!password) return alert("비밀번호를 입력하세요.");

        const delRes = await apiFetch("/users/me", {
            method: "DELETE",
            headers: {
                "X-Password": password  
            }
        });



        if (delRes.ok) {
            // JWT 토큰 삭제 (예시: localStorage 사용 시)
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            location.href = "/";
        } else {
             let errMsg = "알 수 없는 오류";
    try {
        if (delRes.headers.get("content-type")?.includes("application/json")) {
            const err = await delRes.json();
            errMsg = "오류: " + err.detail;
        } else {
            errMsg = "오류: " + await delRes.text();
        }
    } catch (e) {
        errMsg = "오류: 서버 응답 파싱 실패";
    }
    document.getElementById("mypageResult").textContent = errMsg;
        }
    });

});
</script>
{% endblock %}
