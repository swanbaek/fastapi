{% extends 'base.html' %}

{% block title %}게시글 작성{% endblock %}

{% block content %}
<div class="container post-form">
    <h2>{% if post %}게시글 수정{% else %}게시글 작성{% endif %}</h2>
    <div class="author-info" style="margin-bottom:1em; text-align:right; color:#222e50; font-weight:500;">
        작성자: <span id="authorName">로그인 필요</span>
    </div>
    <form method="post" action="{% if post %}/posts/{{ post.id }}/edit{% else %}/posts/new{% endif %}" enctype="multipart/form-data" id="postForm">
        <label for="title">제목</label>
        <input type="text" id="title" name="title" placeholder="Title" required value="{{ post.title if post else '' }}">

        <label for="content">글내용</label>
        <textarea id="content" name="content" rows="8" placeholder="Content" required>{{ post.content if post else '' }}</textarea>

        <label for="file">첨부파일</label>
        <input type="file" id="file" name="file">

        {% if post and post.file_url %}
            <div style="margin:10px 0;">
                <strong>기존 첨부파일:</strong>
                {% if post.file_url.endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp')) %}
                    <div style="margin:8px 0;"><img src="{{ post.file_url }}" alt="첨부 이미지" style="max-width:220px; max-height:160px; border-radius:6px;"></div>
                {% endif %}
                <a href="{{ post.file_url }}" download="{{ post.file_name }}">{{ post.file_name }}</a>
                <span style="color:#888; font-size:0.97em;">(새 파일 업로드 시 기존 파일이 교체됩니다)</span>
            </div>
        {% endif %}

        <button type="submit" class="btn btn-primary">저장</button>
        <a href="/posts/list" class="btn btn-light">취소</a>
    </form>
    {% if not current_user %}
    <div class="alert" style="margin-top:1em; color:#c00; text-align:center; font-weight:bold;">로그인 후 글쓰기가 가능합니다.</div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script src="/static/common.js"></script>
<script>
// JWT에서 작성자 이름 표시 및 본인 글이 아닐 때 입력/저장 비활성화
document.addEventListener('DOMContentLoaded', function() {
    const accessToken = localStorage.getItem('accessToken');
    const authorSpan = document.getElementById('authorName');
    const form = document.getElementById('postForm');
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const fileInput = document.getElementById('file');
    const submitBtn = form.querySelector('button[type="submit"]');
    let isOwner = false;

    // 글 수정 폼이면 본인 글만 수정 가능
    {% if post %}
    const postAuthorId = {{ post.author.id }};
    {% else %}
    const postAuthorId = null;
    {% endif %}

    if (accessToken && typeof parseJwt === 'function') {
        const payload = parseJwt(accessToken);
        if (payload && payload.name) {
            authorSpan.textContent = payload.name;
        } else {
            authorSpan.textContent = '알 수 없음';
        }
        // 본인 글이 아니면 입력/저장 비활성화
        if (postAuthorId !== null) {
            if (payload && payload.id === postAuthorId) {
                isOwner = true;
            } else {
                titleInput.disabled = true;
                contentInput.disabled = true;
                fileInput.disabled = true;
                submitBtn.disabled = true;
                showEditAlert('본인 글만 수정할 수 있습니다.');
            }
        } else {
            isOwner = true; // 새 글쓰기
        }
    } else {
        authorSpan.textContent = '로그인 필요';
        if (postAuthorId !== null) {
            titleInput.disabled = true;
            contentInput.disabled = true;
            fileInput.disabled = true;
            submitBtn.disabled = true;
            showEditAlert('로그인 후 수정할 수 있습니다.');
        }
    }

    // 폼 제출
    if (form && isOwner) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!form.title.value.trim() || !form.content.value.trim()) {
                alert('제목과 본문을 입력하세요.');
                return;
            }
            const formData = new FormData(form);
            try {
                const response = await apiFetch(form.action, {
                    method: 'POST',
                    body: formData
                });
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    const data = await response.json();
                    alert(data.detail || '오류가 발생했습니다.');
                }
            } catch (err) {
                alert('네트워크 오류 또는 인증 오류');
                console.error(err);
            }
        });
    }

    function showEditAlert(msg) {
        let alertDiv = document.createElement('div');
        alertDiv.className = 'alert';
        alertDiv.style = 'margin-top:1em; color:#c00; text-align:center; font-weight:bold;';
        alertDiv.textContent = msg;
        form.parentNode.insertBefore(alertDiv, form.nextSibling);
    }
});
</script>
{% endblock %}
